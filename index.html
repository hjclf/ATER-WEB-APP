<?php
// index.php
header('Content-Type: text/html; charset=utf-8');
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aryan X | Complete v18.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F1F5F9; padding-bottom: 90px; transition: 0.3s; }
        
        body.dark-mode { background-color: #0F172A; color: #E2E8F0; }
        body.dark-mode .glass { background: rgba(30, 41, 59, 0.98); border: 1px solid #334155; }
        body.dark-mode .circle-btn { background: #1E293B; border-color: #334155; color: #E2E8F0; }
        body.dark-mode .res-card { background: #1E293B; border-color: #334155; }
        body.dark-mode header { background: rgba(30, 41, 59, 0.9) !important; }
        body.dark-mode input, body.dark-mode textarea { background: #1E293B !important; color: #E2E8F0; border-color: #334155; }
        body.dark-mode .recent-dropdown { background: #1E293B !important; border-color: #334155; }
        
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid #E2E8F0; border-radius: 24px; }
        .circle-btn { width: 62px; height: 62px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; border: 1px solid #E2E8F0; background: white; cursor: pointer; }
        .active-mode { background: #2563EB; color: white; transform: scale(1.1); border: none; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); }
        .circle-btn span { font-size: 7px; font-weight: 800; text-transform: uppercase; margin-top: 4px; }
        .loader { width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid #2563EB; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .res-card { background: white; border-radius: 20px; padding: 15px; border: 1px solid #E2E8F0; margin-top: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .res-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #F1F5F9; }
        .res-row:last-child { border-bottom: none; }
        .res-key { font-size: 10px; font-weight: 800; color: #64748B; text-transform: uppercase; }
        .res-val { font-size: 11px; font-weight: 700; color: #1E293B; text-align: right; word-break: break-all; max-width: 60%; }

        #toast-box { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: #0F172A; color: white; padding: 12px 20px; border-radius: 12px; margin-bottom: 10px; font-size: 12px; font-weight: 800; animation: slideIn 0.3s; border-left: 4px solid #3B82F6; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .ticker-wrap { background: #2563EB; color: white; padding: 8px 0; overflow: hidden; white-space: nowrap; position: sticky; top: 0; z-index: 60; }
        .ticker { display: inline-block; animation: ticker 25s linear infinite; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        .bottom-nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 480px; background: #0F172A; border-radius: 22px; height: 70px; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-btn { color: #94A3B8; display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; cursor: pointer; }
        .nav-btn.active { color: #3B82F6; }
        .nav-btn span { font-size: 9px; font-weight: 800; text-transform: uppercase; }
        
        .recent-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #E2E8F0; border-radius: 12px; margin-top: 5px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
        .recent-dropdown.show { display: block; }
        .recent-item { padding: 10px 15px; cursor: pointer; font-size: 11px; font-weight: 600; border-bottom: 1px solid #F1F5F9; transition: 0.2s; }
        .recent-item:hover { background: #F1F5F9; }
        .recent-clear { background: #EF4444; color: white; text-align: center; padding: 8px; font-size: 10px; font-weight: 800; cursor: pointer; border-radius: 0 0 12px 12px; }
        
        .admin-tab { padding: 10px 20px; background: #F1F5F9; border-radius: 12px; font-size: 11px; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .admin-tab.active-tab { background: #2563EB; color: white; }
        
        .badge { display: inline-block; padding: 2px 8px; border-radius: 8px; font-size: 9px; font-weight: 800; text-transform: uppercase; }
        .badge-success { background: #10B981; color: white; }
        .badge-danger { background: #EF4444; color: white; }
        .badge-warning { background: #F59E0B; color: white; }

        .plan-btn.active { ring-2 ring-indigo-400 ring-offset-2; }
    </style>
</head>
<body>
    <div id="toast-box"></div>

    <div id="auth-screen" class="fixed inset-0 z-[4000] flex items-center justify-center bg-slate-100 p-6">
        <div class="glass p-8 w-full max-w-sm shadow-2xl text-center">
            <h1 class="text-3xl font-black text-blue-600 italic mb-2">ARYAN X</h1>
            <p class="text-[9px] font-bold text-slate-400 mb-6 uppercase">Complete v18.6 - Firebase Cloud</p>
            <div id="login-form" class="space-y-4 text-left">
                <input type="text" id="log-user" placeholder="User ID" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                <input type="password" id="log-pass" placeholder="Password" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">LOGIN</button>
                <button onclick="toggleReg()" class="w-full text-[10px] font-bold text-blue-600 uppercase">Register</button>
            </div>
            <div id="reg-form" class="hidden space-y-4 text-left">
                <input type="text" id="reg-user" placeholder="User ID" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                <input type="password" id="reg-pass" placeholder="Password" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                <input type="text" id="reg-referral" placeholder="Referral Code (Optional)" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none text-xs">
                <button onclick="handleRegister()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black shadow-lg">CREATE (5 CR)</button>
                <button onclick="toggleReg()" class="w-full text-[10px] font-bold text-slate-400 uppercase">Back</button>
            </div>
        </div>
    </div>

    <div id="main-dashboard" class="hidden">
        <div class="ticker-wrap"><div class="ticker" id="broadcast-bar">Welcome to Aryan X Complete - All Features Working!</div></div>
        <header class="bg-white/90 p-4 border-b flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center gap-3">
                <button id="header-back-btn" onclick="clearResults()" class="hidden bg-blue-600 text-white p-2 rounded-full h-9 w-9 flex items-center justify-center shadow-lg"><i class="fas fa-arrow-left text-sm"></i></button>
                <span class="font-black text-blue-600 italic">ARYAN X</span>
            </div>
            <button id="night-mode-toggle" onclick="toggleNightMode()" class="bg-slate-100 text-slate-700 p-2 rounded-full h-9 w-9 flex items-center justify-center shadow-md border border-slate-300">
                <i class="fas fa-moon text-sm"></i>
            </button>
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white px-3 py-1 rounded-full text-[10px] font-black">₹ <span id="user-credits">0</span></div>
                <button id="admin-btn" onclick="openAdmin()" class="hidden bg-red-100 text-red-600 p-2 rounded-full h-8 w-8 flex items-center justify-center"><i class="fas fa-user-shield text-xs"></i></button>
            </div>
        </header>

        <main class="p-5 max-w-lg mx-auto">
            <div id="tab-home">
                <div class="glass p-6 mb-8 border-b-4 border-blue-600 shadow-xl">
                    <p id="mode-label" class="text-[10px] font-black text-blue-600 mb-2 uppercase italic">Mobile Mode</p>
                    <div class="relative">
                        <input type="text" id="target-input" placeholder="Enter info..." class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 font-bold outline-none" onfocus="showRecentSearches()" onblur="hideRecentSearches()">
                        <div id="recent-searches" class="recent-dropdown"></div>
                    </div>
                    <button onclick="runSearch()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-black shadow-lg">SEARCH</button>
                </div>

                <div id="feature-grid" class="grid grid-cols-4 gap-y-6 mb-10 justify-items-center"></div>
                
                <div id="results-area"></div>
                <button id="back-btn" onclick="clearResults()" class="hidden w-full bg-slate-200 text-slate-600 p-4 rounded-2xl font-black mt-4 uppercase text-xs"><i class="fas fa-arrow-left mr-2"></i> Back</button>
            </div>

            <div id="tab-history" class="hidden">
                <div class="glass p-6 shadow-xl">
                    <h2 class="text-sm font-black mb-4 uppercase">Search History</h2>
                    <div id="history-container" class="space-y-3"></div>
                </div>
            </div>

            <div id="tab-recharge" class="hidden">
                <div class="glass p-6 shadow-xl mb-6">
                    <h2 class="text-lg font-black mb-5 uppercase text-center">Buy Credits / Plans</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl text-white shadow-xl border border-slate-700">
                            <h3 class="text-base font-black mb-4 uppercase tracking-wide text-center">Normal Buy</h3>
                            <p class="text-xs text-slate-400 mb-5 text-center">Add credits instantly</p>
                            
                            <div class="space-y-4">
                                <input type="number" id="normal-amount" placeholder="Enter amount (₹)" class="w-full p-4 bg-slate-700 border border-slate-600 rounded-xl font-bold text-white outline-none text-center placeholder-slate-400" min="50">
                                <button onclick="redirectToTelegramNormal()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-black shadow-lg transition">BUY NOW</button>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-4 text-center">₹1 = 1 Credit • Instant • Min ₹50</p>
                        </div>

                        <div class="bg-gradient-to-br from-purple-900/40 to-indigo-900/40 p-6 rounded-2xl shadow-xl border border-purple-700/50">
                            <h3 class="text-base font-black mb-5 uppercase tracking-wide text-center text-purple-300">VIP Unlimited Plans</h3>
                            <div class="space-y-4">
                                <div class="bg-slate-800/80 backdrop-blur-sm p-5 rounded-xl border border-cyan-700/40 hover:border-cyan-500/70 transition">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="font-black text-cyan-400">SILVER</h4>
                                        <span class="badge bg-cyan-600 text-white px-3 py-1 text-xs">24 HOURS</span>
                                    </div>
                                    <p class="text-xs text-slate-300 mb-3">Unlimited searches • All features</p>
                                    <button onclick="redirectToTelegramVip('silver', 299)" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-3 rounded-lg font-bold text-sm transition">₹299 • Activate</button>
                                </div>

                                <div class="bg-slate-800/80 backdrop-blur-sm p-5 rounded-xl border border-amber-700/40 hover:border-amber-500/70 transition">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="font-black text-amber-400">GOLD</h4>
                                        <span class="badge bg-amber-600 text-white px-3 py-1 text-xs">15 DAYS</span>
                                    </div>
                                    <p class="text-xs text-slate-300 mb-3">Unlimited searches + Priority</p>
                                    <button onclick="redirectToTelegramVip('gold', 799)" class="w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-lg font-bold text-sm transition">₹799 • Activate</button>
                                </div>

                                <div class="bg-slate-800/80 backdrop-blur-sm p-5 rounded-xl border border-pink-700/40 hover:border-pink-500/70 transition">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="font-black text-pink-400">DIAMOND</h4>
                                        <span class="badge bg-pink-600 text-white px-3 py-1 text-xs">30 DAYS</span>
                                    </div>
                                    <p class="text-xs text-slate-300 mb-3">Unlimited + VIP Support + Early Access</p>
                                    <button onclick="redirectToTelegramVip('diamond', 1499)" class="w-full bg-pink-600 hover:bg-pink-700 text-white py-3 rounded-lg font-bold text-sm transition">₹1,499 • Activate</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass p-6 shadow-xl">
                    <h3 class="text-sm font-black mb-4 uppercase flex items-center gap-2"><i class="fas fa-gift text-yellow-500"></i> Referral System</h3>
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-6 rounded-2xl text-white mb-4">
                        <p class="text-[9px] font-bold uppercase mb-2">Your Code</p>
                        <div class="flex items-center gap-2">
                            <p class="text-2xl font-black font-mono" id="ref-code">-</p>
                            <button onclick="copyReferralCode()" class="bg-white/20 p-2 rounded-lg hover:bg-white/30"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-50 p-4 rounded-2xl text-center border">
                            <p class="text-[9px] font-bold uppercase text-slate-500">Referrals</p>
                            <p class="text-2xl font-black text-blue-600" id="ref-count">0</p>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl text-center border">
                            <p class="text-[9px] font-bold uppercase text-slate-500">Earned</p>
                            <p class="text-2xl font-black text-green-600" id="ref-earnings">0 CR</p>
                        </div>
                    </div>
                    <p class="text-[9px] font-bold mt-4 text-center text-slate-500">₹ Earn 2 CR per referral!</p>
                </div>
            </div>

            <div id="tab-profile" class="hidden">
                <div class="glass p-6 shadow-xl text-center">
                    <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-2xl font-black">A</div>
                    <h2 class="font-black uppercase mb-1" id="prof-uid">User ID</h2>
                    <p class="text-[10px] font-bold text-slate-400 mb-6 uppercase">Aryan X Member</p>
                    
                    <div class="space-y-3 text-left">
                        <div class="bg-slate-50 p-4 rounded-2xl border font-bold text-xs flex justify-between">
                            <span>Credits</span><span class="text-blue-600" id="prof-credits">0</span>
                        </div>
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-2xl border font-bold text-xs flex justify-between items-center">
                            <span>Active Plan</span>
                            <div class="text-right">
                                <span id="prof-plan" class="px-3 py-1 rounded-full text-white text-[10px] font-black uppercase">Normal</span>
                                <p id="prof-expiry" class="text-[9px] text-slate-600 mt-1"></p>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl border font-bold text-xs flex justify-between">
                            <span>Referral</span><span class="text-purple-600 font-mono" id="prof-ref-code">-</span>
                        </div>
                        <a href="https://t.me/aryan_trial72_bot" target="_blank" class="block bg-slate-50 p-4 rounded-2xl border font-bold text-xs flex justify-between">
                            <span>Support</span><span class="text-blue-600">Bot</span>
                        </a>
                    </div>
                    
                    <button onclick="handleLogout()" class="w-full bg-red-50 text-red-600 py-4 rounded-2xl font-black text-xs uppercase mt-6">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button onclick="showTab('home')" class="nav-btn active" id="btn-home"><i class="fas fa-search"></i><span>Search</span></button>
            <button onclick="showTab('history')" class="nav-btn" id="btn-history"><i class="fas fa-history"></i><span>History</span></button>
            <button onclick="showTab('recharge')" class="nav-btn" id="btn-recharge"><i class="fas fa-bolt"></i><span>Buy</span></button>
            <button onclick="showTab('profile')" class="nav-btn" id="btn-profile"><i class="fas fa-user"></i><span>Profile</span></button>
        </nav>
    </div>

    <div id="admin-panel" class="fixed inset-0 bg-white/90 z-[5000] hidden p-8 overflow-y-auto">
        <div class="max-w-2xl mx-auto pb-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-blue-600">ADMIN PANEL</h2>
                <button onclick="closeAdmin()" class="bg-red-500 text-white h-10 w-10 rounded-full font-bold">X</button>
            </div>
            
            <div class="flex gap-2 mb-6 overflow-x-auto">
                <button onclick="showAdminTab('broadcast')" class="admin-tab active-tab" id="admin-tab-broadcast">Broadcast</button>
                <button onclick="showAdminTab('credits')" class="admin-tab" id="admin-tab-credits">Credits</button>
                <button onclick="showAdminTab('plans')" class="admin-tab" id="admin-tab-plans">Plans</button>
                <button onclick="showAdminTab('users')" class="admin-tab" id="admin-tab-users">Users</button>
                <button onclick="showAdminTab('logs')" class="admin-tab" id="admin-tab-logs">Activity</button>
                <button onclick="showAdminTab('stats')" class="admin-tab" id="admin-tab-stats">Stats</button>
            </div>
            
            <div id="admin-content-broadcast" class="admin-content glass p-6 space-y-4">
                <p class="text-[9px] font-black uppercase text-slate-500">Update Broadcast</p>
                <input type="text" id="bc-input" placeholder="Enter message..." class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none">
                <button onclick="setBroadcast()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">UPDATE</button>
            </div>
            
            <div id="admin-content-credits" class="admin-content hidden glass p-6 space-y-4">
                <p class="text-[9px] font-black uppercase text-slate-500">Single User</p>
                <input type="text" id="target-uid" placeholder="User ID" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none">
                <input type="number" id="add-amount" placeholder="Amount" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none">
                <div class="flex gap-2">
                    <button onclick="manageCredits('add')" class="flex-1 bg-green-500 text-white py-4 rounded-xl font-black">Add</button>
                    <button onclick="manageCredits('minus')" class="flex-1 bg-red-500 text-white py-4 rounded-xl font-black">Minus</button>
                </div>
                
                <div class="mt-6 pt-6 border-t">
                    <p class="text-[9px] font-black uppercase text-slate-500 mb-3">Bulk Operations</p>
                    <textarea id="bulk-uids" placeholder="User IDs (one per line)" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none text-xs" rows="4"></textarea>
                    <input type="number" id="bulk-amount" placeholder="Credits" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none mt-3">
                    <button onclick="bulkAddCredits()" class="w-full bg-purple-600 text-white p-4 rounded-xl font-black mt-3">BULK ADD</button>
                </div>
            </div>

            <div id="admin-content-plans" class="admin-content hidden glass p-6 space-y-6">
                <h3 class="text-sm font-black uppercase mb-4">Manage User Plans</h3>
                <div class="space-y-4">
                    <input type="text" id="plan-uid" placeholder="Enter User ID" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none border">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectPlan('Normal')" class="plan-btn bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-bold" data-plan="Normal">Normal</button>
                        <button onclick="selectPlan('Silver')" class="plan-btn bg-slate-500 hover:bg-slate-600 text-white py-3 rounded-lg font-bold" data-plan="Silver">Silver (24h)</button>
                        <button onclick="selectPlan('Gold')" class="plan-btn bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-lg font-bold" data-plan="Gold">Gold (15 Days)</button>
                        <button onclick="selectPlan('Diamond')" class="plan-btn bg-pink-600 hover:bg-pink-700 text-white py-3 rounded-lg font-bold" data-plan="Diamond">Diamond (30 Days)</button>
                    </div>
                    <input type="date" id="plan-expiry" class="w-full p-4 bg-slate-50 rounded-xl font-bold outline-none border">
                    <button onclick="activateUserPlan()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl font-black shadow-lg mt-2">ACTIVATE PLAN</button>
                    <p id="plan-status" class="text-center text-sm font-bold text-slate-600 mt-4"></p>
                </div>
            </div>
            
            <div id="admin-content-users" class="admin-content hidden glass p-6">
                <h3 class="text-sm font-black uppercase mb-4 flex justify-between"><span>Users</span><span id="total-users" class="text-blue-600">0</span></h3>
                <div id="admin-user-list" class="space-y-3"></div>
            </div>
            
            <div id="admin-content-logs" class="admin-content hidden glass p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-black uppercase">Activity Logs</h3>
                    <button onclick="clearActivityLogs()" class="text-[9px] font-black bg-red-100 text-red-600 px-3 py-2 rounded-lg">Clear</button>
                </div>
                <div id="activity-logs" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
            
            <div id="admin-content-stats" class="admin-content hidden glass p-6">
                <h3 class="text-sm font-black uppercase mb-4">API Statistics</h3>
                <div id="api-stats" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCF3fZ3b2d9jhRCrdfML6v1I_mYzVc2_Vk",
            databaseURL: "https://ater-web-app-default-rtdb.firebaseio.com",
            projectId: "ater-web-app",
            storageBucket: "ater-web-app.firebasestorage.app"
        };
        firebase.initializeApp(firebaseConfig);
        const rtdb = firebase.database();

        // Telegram Mini App Setup
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            const tgUser = tg.initDataUnsafe?.user;
            if (tgUser) console.log("Telegram User:", tgUser);
        }

        // --- CORE STATE ---
        let db = {}; // Will be loaded from Firebase
        let bcMsg = "Welcome to Aryan X Complete - All Features Working!";
        let currentUser = null;
        let activeMode = 'mobile';
        let currentResultData = null;
        let recentSearches = JSON.parse(localStorage.getItem('aryan_recent')) || [];
        let searchHistory = JSON.parse(localStorage.getItem('aryan_history')) || [];
        let activityLogs = JSON.parse(localStorage.getItem('aryan_logs')) || [];
        let apiStats = JSON.parse(localStorage.getItem('aryan_stats')) || {};
        let selectedPlan = "Normal";

        const APIS = {
            "PHONE": "https://www.zephrexdigital.site/api?key=ZEPH-OT3C5&type=PHONE&term={term}",
            "PAK_PHONE": "https://www.zephrexdigital.site/api?key=ZEPH-DA7L6&type=PAK_PHONE&term={term}",
            "AADHAAR": "https://www.zephrexdigital.site/api?key=ZEPH-7BGR9&type=AADHAAR&term={term}",
            "FAMILY": "https://www.zephrexdigital.site/api?key=ZEPH-XGO26&type=FAMILY&term={term}",
            "IFSC": "https://www.zephrexdigital.site/api?key=ZEPH-CU57X&type=IFSC&term={term}",
            "IP": "https://www.zephrexdigital.site/api?key=ZEPH-U3K3B&type=IP&term={term}",
            "TG_USER": "https://www.zephrexdigital.site/api?key=ZEPH-UQ83I&type=TG_NUM&term={term}",
            "GST": "https://www.zephrexdigital.site/api?key=ZEPH-R0UT8&type=GST&term={term}",
            "PAN": "https://www.zephrexdigital.site/api?key=ZEPH-OP08F&type=PAN&term={term}",
            "PAN_GST": "https://www.zephrexdigital.site/api?key=ZEPH-KC02P&type=PAN_GST&term={term}",
            "VNUM": "https://www.zephrexdigital.site/api?key=ZEPH-PMG45&type=VNUM&term={term}",
            "IMEI": "https://www.zephrexdigital.site/api?key=ZEPH-P19EH&type=IMEI&term={term}",
            "PINCODE": "https://www.zephrexdigital.site/api?key=ZEPH-8PBY6&type=PINCODE&term={term}",
            "FREEFIRE": "https://www.zephrexdigital.site/api?key=ZEPH-M0AD9&type=FREEFIRE&term={term}",
            "CNIC": "https://www.zephrexdigital.site/api?key=ZEPH-IH1L6&type=CNIC&term={term}",
            "UPI": "https://www.zephrexdigital.site/api?key=ZEPH-P1NE4&type=UPI&term={term}",
            "CHALLAN": "https://www.zephrexdigital.site/api?key=ZEPH-T8RU3&type=CHALLAN&term={term}",
            "SMS_BOMBER": "https://www.zephrexdigital.site/api?key=ZEPH-3Z9YH&type=SMS_BOMBER&term={term}",
            "INSTAGRAM": "https://www.zephrexdigital.site/api?key=ZEPH-GMI91&type=INSTAGRAM&term={term}",
            "VEHICLE": "https://www.zephrexdigital.site/api?key=ZEPH-72CIR&type=VEHICLE&term={term}"
        };

        const modes = [
            {id:'mobile',icon:'fa-phone',label:'Mobile',param:'number',type:'zephrex', apiKey:'PHONE'},
            {id:'aadhaar',icon:'fa-id-card',label:'Aadhaar',param:'id',type:'zephrex', apiKey:'AADHAAR'},
            {id:'pan',icon:'fa-id-badge',label:'PAN',param:'pan',type:'zephrex', apiKey:'PAN'},
            {id:'vehicle',icon:'fa-car',label:'RC Info',param:'number',type:'zephrex', apiKey:'VEHICLE'},
            {id:'paytm',icon:'fa-credit-card',label:'Paytm',param:'num',type:'mock'},
            {id:'gst',icon:'fa-file-invoice-dollar',label:'GST',param:'number',type:'zephrex', apiKey:'GST'},
            {id:'ifsc',icon:'fa-university',label:'IFSC',param:'code',type:'zephrex', apiKey:'IFSC'},
            {id:'upi',icon:'fa-qrcode',label:'UPI',param:'id',type:'zephrex', apiKey:'UPI'},
            {id:'pincode',icon:'fa-map-pin',label:'Pincode',param:'pincode',type:'zephrex', apiKey:'PINCODE'},
            {id:'instagram',icon:'fa-instagram',label:'Insta',param:'username',type:'zephrex', apiKey:'INSTAGRAM'},
            {id:'github',icon:'fa-github',label:'GitHub',param:'username',type:'mock'},
            {id:'ip',icon:'fa-network-wired',label:'IP',param:'ip',type:'zephrex', apiKey:'IP'},
            {id:'telegram',icon:'fa-paper-plane',label:'Telegram',param:'user',type:'zephrex', apiKey:'TG_USER'},
            {id:'upi2',icon:'fa-qrcode',label:'UPI v2',param:'id',type:'zephrex', apiKey:'UPI'},
            {id:'rashan',icon:'fa-utensils',label:'Rashan',param:'aadhaar',type:'zephrex', apiKey:'FAMILY'},
            {id:'ff-info',icon:'fa-gamepad',label:'FF UID',param:'uid',type:'zephrex', apiKey:'FREEFIRE'}
        ];

        // --- FIREBASE SYNC ---
        rtdb.ref('users').on('value', (snapshot) => {
            db = snapshot.val() || {};
            if(currentUser) updateUI();
        });

        rtdb.ref('broadcast').on('value', (snapshot) => {
            bcMsg = snapshot.val() || "Welcome to Aryan X";
            document.getElementById('broadcast-bar').innerText = bcMsg;
        });

        function saveDBUser(uid, userData){
            rtdb.ref('users/' + uid).set(userData);
        }

        // --- ORIGINAL FUNCTIONS ---
        function toast(msg){
            const box = document.getElementById('toast-box');
            const div = document.createElement('div');
            div.className = "toast";
            div.innerText = msg;
            box.appendChild(div);
            setTimeout(()=>div.remove(),3000);
        }

        function generateReferralCode(){
            return 'REF'+Math.random().toString(36).substr(2,6).toUpperCase();
        }

        function renderGrid(){
            const grid=document.getElementById('feature-grid');
            grid.innerHTML="";
            modes.forEach(m=>{
                const div=document.createElement('div');
                div.className=`circle-btn ${m.id===activeMode?'active-mode':''}`;
                div.innerHTML=`<i class="fas ${m.icon}"></i><span>${m.label}</span>`;
                div.onclick=()=>{activeMode=m.id;renderGrid();document.getElementById('mode-label').innerText=m.label+" Mode";};
                grid.appendChild(div);
            });
        }
        renderGrid(); 
        
        function handleLogin(){
            const u = document.getElementById('log-user').value.trim();
            const p = document.getElementById('log-pass').value;
            if(db[u] && db[u].password === p){
                if(db[u].status === 'suspended') return toast("Account Suspended!");
                
                currentUser = u;
                checkPlanExpiry(u);
                
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-dashboard').classList.remove('hidden');
                if(u === "6571524546") document.getElementById('admin-btn').classList.remove('hidden');
                document.getElementById('prof-uid').innerText = u;
                updateUI();
                updateReferralUI();
                logActivity(u,'LOGIN','User logged in');
                toast("Logged in!");
                loadNightMode();
            } else toast("Invalid!");
        }

        function handleRegister(){
            const u = document.getElementById('reg-user').value.trim();
            const p = document.getElementById('reg-pass').value;
            const refCode = document.getElementById('reg-referral').value.trim();
            if(!u || !p) return toast("Fill all!");
            if(db[u]) return toast("ID taken!");
            
            const newUser = {
                password: p,
                credits: 5.0,
                referralCode: generateReferralCode(),
                referrals: 0,
                earnings: 0,
                status: 'active',
                joinedBy: refCode || null,
                activePlan: "Normal",
                planExpiry: null
            };
            
            if(refCode){
                const referrer = Object.keys(db).find(uid=>db[uid].referralCode === refCode);
                if(referrer && referrer !== u){
                    rtdb.ref('users/' + referrer).once('value', (snap) => {
                        let data = snap.val();
                        data.referrals = (data.referrals || 0) + 1;
                        data.earnings = (data.earnings || 0) + 2;
                        data.credits = (data.credits || 0) + 2;
                        rtdb.ref('users/' + referrer).set(data);
                    });
                }
            }
            
            saveDBUser(u, newUser);
            toggleReg();
            logActivity(u,'REGISTER','New account');
            toast("Account created! 5 CR");
        }

        function checkPlanExpiry(userId){
            if(!db[userId] || !db[userId].activePlan || db[userId].activePlan === "Normal") return;
            const expiry = db[userId].planExpiry;
            if(!expiry) return;
            const expiryDate = new Date(expiry);
            const now = new Date();
            if(now > expiryDate){
                rtdb.ref('users/' + userId).update({
                    activePlan: "Normal",
                    planExpiry: null
                });
                toast("VIP प्लान एक्सपायर हो गया!");
            }
        }

        async function runSearch(){
            const input = document.getElementById('target-input').value.trim();
            if(!input) return toast("Enter something!");
            if(!currentUser) return toast("Please login first!");

            const modeObj = modes.find(m => m.id === activeMode);
            const user = db[currentUser];

            const cost = (user.activePlan === "Normal") ? 1 : 0;
            if(cost > 0 && user.credits < cost) return toast("Insufficient Credits!");

            toast("Searching...");
            let url = 'https://corsproxy.io/?' + encodeURIComponent(APIS[modeObj.apiKey].replace('{term}', encodeURIComponent(input)));

            try {
                const response = await fetch(url);
                const rawData = await response.json();
                let resultData = rawData.data || rawData || {};

                if(cost > 0) rtdb.ref('users/' + currentUser + '/credits').set(user.credits - cost);

                addToHistory(activeMode, input, resultData);
                saveRecent(input);
                currentResultData = resultData;
                renderResults(resultData, modeObj.label, input);
                logActivity(currentUser, 'SEARCH', `${modeObj.label} for ${input}`);
            } catch(e){
                toast("Search failed!");
            }
        }

        function renderResults(data, modeLabel, query){
            const area = document.getElementById('results-area');
            let html = `
                <div class="glass p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <span class="text-xs font-black uppercase text-blue-600">${modeLabel} RESULT</span>
                            <p class="font-black text-lg">${query}</p>
                        </div>
                        <button onclick="downloadPDF()" class="bg-blue-600 text-white px-5 py-2 rounded-xl text-xs font-black">PDF</button>
                    </div>
                    <div class="res-card">
            `;

            function addRows(obj){
                for(let key in obj){
                    if(typeof obj[key] === 'object' && obj[key] !== null) addRows(obj[key]);
                    else html += `<div class="res-row"><span class="res-key">${key.toUpperCase()}</span><span class="res-val">${obj[key]}</span></div>`;
                }
            }
            addRows(data);
            html += `</div></div>`;
            area.innerHTML = html;
            document.getElementById('feature-grid').classList.add('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('header-back-btn').classList.remove('hidden');
        }

        // --- OTHER ORIGINAL LOGIC ---
        function showTab(tab){
            ['home','history','recharge','profile'].forEach(t=>document.getElementById('tab-'+t).classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.remove('hidden');
            document.getElementById('btn-'+tab).classList.add('active');
            if(tab==='home') clearResults();
            if(tab==='history') renderHistory();
            if(tab==='recharge') updateReferralUI();
        }

        function updateUI(){
            const user = db[currentUser];
            if(!user) return;
            document.getElementById('user-credits').innerText = user.credits.toFixed(1);
            document.getElementById('prof-credits').innerText = user.credits.toFixed(1);
            document.getElementById('prof-plan').innerText = user.activePlan;
            document.getElementById('prof-ref-code').innerText = user.referralCode;
        }

        function updateReferralUI(){
            const user = db[currentUser];
            document.getElementById('ref-code').innerText = user.referralCode;
            document.getElementById('ref-count').innerText = user.referrals || 0;
            document.getElementById('ref-earnings').innerText = (user.earnings || 0) + " CR";
        }

        function clearResults(){
            document.getElementById('results-area').innerHTML = "";
            document.getElementById('back-btn').classList.add('hidden');
            document.getElementById('header-back-btn').classList.add('hidden');
            document.getElementById('feature-grid').classList.remove('hidden');
        }

        function setBroadcast(){
            const msg = document.getElementById('bc-input').value.trim();
            rtdb.ref('broadcast').set(msg);
            toast("Updated!");
        }

        function manageCredits(type){
            const uid = document.getElementById('target-uid').value.trim();
            const amt = parseFloat(document.getElementById('add-amount').value);
            if(!db[uid]) return toast("User not found!");
            let newCreds = type === 'add' ? db[uid].credits + amt : db[uid].credits - amt;
            rtdb.ref('users/' + uid + '/credits').set(newCreds);
            toast("Done!");
        }

        function activateUserPlan(){
            const uid = document.getElementById('plan-uid').value.trim();
            const expiry = document.getElementById('plan-expiry').value;
            if(!db[uid]) return toast("User not found!");
            rtdb.ref('users/' + uid).update({
                activePlan: selectedPlan,
                planExpiry: expiry ? new Date(expiry).toISOString() : null
            });
            toast("Plan Activated!");
        }

        function selectPlan(p){
            selectedPlan = p;
            document.querySelectorAll('.plan-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-plan="${p}"]`).classList.add('active');
        }

        function logActivity(u, t, a){
            const log = {u, t, a, time: new Date().toLocaleString()};
            activityLogs.unshift(log);
            localStorage.setItem('aryan_logs', JSON.stringify(activityLogs));
        }

        function toggleNightMode(){
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('aryan_night', document.body.classList.contains('dark-mode'));
        }

        function loadNightMode(){
            if(localStorage.getItem('aryan_night') === 'true') document.body.classList.add('dark-mode');
        }

        function openAdmin(){ document.getElementById('admin-panel').classList.remove('hidden'); }
        function closeAdmin(){ document.getElementById('admin-panel').classList.add('hidden'); }
        function toggleReg(){ document.getElementById('login-form').classList.toggle('hidden'); document.getElementById('reg-form').classList.toggle('hidden'); }
        function handleLogout(){ location.reload(); }
        
        // Additional UI helpers
        function showAdminTab(tab){
            document.querySelectorAll('.admin-content').forEach(c=>c.classList.add('hidden'));
            document.getElementById('admin-content-'+tab).classList.remove('hidden');
        }

    </script>
</body>
</html>
